---
title: "From QIIME2 to Phyloseq"
output: html_notebook
---


## Load libraries
```{r}
library(qiime2R)
library(phyloseq)
library(ggplot2)
library(tidyverse)
```

## Set parameters
```{r}
asvlevel=TRUE
truncationlvl<-"234"

authorname<-"alldir"
directory<-paste0("./data/",authorname,"-data/")
qiimedir<-paste0(directory,"qiime/")

if(asvlevel==TRUE){
  agglom.rank<-"OTU"
}else{
  agglom.rank<-"Genus"
}
read.end.type<-"single"
source("./r-scripts/make_ps_pretty.R")
```


## Import qza files and convert them into a phyloseq object
```{r}
ps.q<-qza_to_phyloseq(
  # metadata = paste0(qiimedir,"filenames-",authorname,"-supercomp.tsv"),
  features = paste0(qiimedir,"pooled-",read.end.type,"-filtered-table-trimmed-dada2-",
                    truncationlvl,".qza"),
  taxonomy = paste0(qiimedir,"pooled-",read.end.type,"-taxonomy-trimmed-dada2-",
                    truncationlvl,".qza"),
  tree = paste0(qiimedir,"pooled-",read.end.type,"-rooted-tree-trimmed-dada2-",
                truncationlvl,".qza")
)
```

Add custom metadata cause previous command loses metadata for some reason
```{r}
custom.md<-read.table(paste0(directory,"filenames-single-pooled-raw-supercomp.tsv"),
                      header = T)
colnames(custom.md)[1]<-"Sample"
custom.md<-custom.md%>%column_to_rownames(var = "Sample")

sample_data(ps.q)<-custom.md

``` 

You can exclude some samples based on class
```{r}
# custom.md<-custom.md[!custom.md$class  %in% c('pal','ppg','pvo','tx',
#                                               'ntccontrol','rabbitcontrol',
#                                               'harecontrol'),]
custom.md<-custom.md[!custom.md$class  %in% c('pal','ppg','tx'),]
custom.md<-custom.md[!rownames(custom.md) %in%
                       intersect(names(which(colSums(ps.q@otu_table)<20000)),
                                 rownames(custom.md)),]
```


## Construct the phyloseq object directly from dada2 output
We combine qza files with new metadata

```{r}
ps.foo <- phyloseq(otu_table(ps.q),
                   sample_data(custom.md),
                   tax_table(ps.q),
                   phy_tree(ps.q))
ps.q<-ps.foo
rm(ps.foo)
```

## Create a dataframe of relative abundances
Agglomerate by agglom.rank, transform into relative abundances, then create a dataframe
```{r}
if(asvlevel==TRUE){
  ps.q.agg.rel<-ps.q %>%
    subset_taxa(Kingdom=="d__Bacteria")%>% # choose only bacteria
    transform_sample_counts(function(x)100* x / sum(x)) %>% # transform into percentages
    psmelt()#%>%  # transform the phyloseq object into an R dataframe
}else{
  ps.q.agg.rel<-ps.q %>%
    tax_glom(agglom.rank,NArm = FALSE) %>% # agglomerate by agglom.rank
    subset_taxa(Kingdom=="d__Bacteria")%>% # choose only bacteria
    transform_sample_counts(function(x)100* x / sum(x)) %>% # transform into percentages
    psmelt()#%>%  # transform the phyloseq object into an R dataframe
  #filter(Abundance!=0)
}
head(ps.q.agg.rel) 
```


Rename d__Bacteria
```{r}
ps.q.agg.rel$Kingdom<-
  gsub("d__","",ps.q.agg.rel$Kingdom)
```

### Replace empty taxa with Unclassified+previous taxonomic level
```{r}
if(asvlevel==TRUE){
  ps.q.agg.rel.pretty<-make_ps_pretty(ps.q.agg.rel,"Species")
}else{
  ps.q.agg.rel.pretty<-make_ps_pretty(ps.q.agg.rel,agglom.rank) 
}
ps.q.agg.rel<-ps.q.agg.rel.pretty
rm(ps.q.agg.rel.pretty)
```

Sanity check: is total relative abundance of each sample 100%?
```{r}
ps.q.agg.rel %>%
  group_by(Sample) %>% # Group by sample id
  mutate(Abundance = as.numeric(Abundance))%>% # transform Abundance column into numeric
  summarise(Abundance = sum(Abundance)) %>% # Sum all abundances
  pull(Abundance) %>% # get only a vector of numbers
  `==`(100) %>% # compare each value to 100 (TRUE/FALSE)
  all() # get one TRUE/FALSE value
```

## Get total counts for each sample
```{r}
if(asvlevel==TRUE){
  ps.q.total<-ps.q %>%
    subset_taxa(Kingdom=="d__Bacteria")%>% # choose only bacteria
    psmelt() %>% # transform the phyloseq object into an R dataframe
    group_by(Sample) %>% # group by Sample id to perform operations on samples
    summarise(Abundance=sum(Abundance)) # sum abundances by sample id
}else{
  ps.q.total<-ps.q %>%
    tax_glom(agglom.rank,NArm = FALSE) %>% # agglomerate by agglom.rank
    subset_taxa(Kingdom=="d__Bacteria")%>% # choose only bacteria
    psmelt() %>% # transform the phyloseq object into an R dataframe
    group_by(Sample) %>% # group by Sample id to perform operations on samples
    summarise(Abundance=sum(Abundance)) # sum abundances by sample id
}
```


## Extract taxa with highest mean relative abundance dataset of four columns: class, two taxonomic ranks (e.g Genus, Family) and abundance 

Group the dataframe by classes
```{r}
classcol<-which(colnames(ps.q.agg.rel) =="class")
agglom.rank.col<-which(colnames(ps.q.agg.rel) ==agglom.rank)
ps.q.agg.rel%>%
  group_by_at(c(classcol,agglom.rank.col,agglom.rank.col-1))%>% 
  mutate(Abundance = as.numeric(Abundance))%>% 
  summarise(Abundance = mean(Abundance)) %>%
  ungroup()%>%
  group_by(class)%>%
  summarise(sss=sum(Abundance))
```

For each class, we take a genus, sum its abundances from all samples, then take 
a mean. This will be our new Abundance
```{r}
if(asvlevel==TRUE){
  ps.q.agg.rel.pooled<-ps.q.agg.rel%>%
    group_by_at(c(classcol,agglom.rank.col,agglom.rank.col-1))%>% # group by class,
    # agglom.rank and the preceding column (based on index)
    mutate(Abundance = as.numeric(Abundance))%>% # convert Abundance column into numeric
    summarise(Abundance = mean(Abundance)) %>% # convert Abundance into mean abundance
    group_by(class,OTU)%>%
    arrange(class,desc(Abundance))%>% # order descending
    filter(Abundance!=0)
}else{
  ps.q.agg.rel.pooled<-ps.q.agg.rel%>%
    group_by_at(c(classcol,agglom.rank.col,agglom.rank.col-1))%>% # group by class,
    # agglom.rank and the preceding column (based on index)
    mutate(Abundance = as.numeric(Abundance))%>% # convert Abundance column into numeric
    summarise(Abundance = mean(Abundance)) %>% # convert Abundance into mean abundance
    group_by(class,Genus,Family)%>%
    arrange(class,desc(Abundance))%>% # order descending
    filter(Abundance!=0)
}
```

Get otus with mean abundance >1%
```{r}
ps.q.1pc<-ps.q.agg.rel.pooled[ps.q.agg.rel.pooled$Abundance>1,]
```

If otu has mean rel.ab <1%, set it as Remainder.

Taxon.bp is for barplot
```{r}
ps.q.agg.rel$Taxon.bp<-ps.q.agg.rel$Taxon
ps.q.agg.rel$Taxon.bp<-ifelse(ps.q.agg.rel[[agglom.rank.col]] %in% ps.q.1pc[[agglom.rank]],
                           ps.q.agg.rel$Taxon.bp,
                            "Remainder (Mean abundance < 1%)")
```

If our Taxon is in the 1pc dataset (mean abundance >1%), keep it as it is. 
Otherwise, set it as Remainder (Mean abundance < 1%)

## Create a dataframe of absolute abundances 
Extract absolute abundances
```{r}
if (asvlevel==TRUE){
  ps.q.agg.abs<-ps.q %>%
    subset_taxa(Kingdom=="d__Bacteria")%>% # choose only bacteria
    psmelt()#%>%  # transform the phyloseq object into an R dataframe
  # filter(Abundance!=0)
}else{
  ps.q.agg.abs<-ps.q %>%
    tax_glom(agglom.rank,NArm = FALSE) %>% # agglomerate by agglom.rank
    subset_taxa(Kingdom=="d__Bacteria")%>% # choose only bacteria
    psmelt()#%>%  # transform the phyloseq object into an R dataframe
  # filter(Abundance!=0)
}
ps.q.agg.abs$Kingdom<-
  gsub("d__","",ps.q.agg.abs$Kingdom)
```

### Replace empty taxa with Unclassified+previous taxon ####
```{r}
if (asvlevel==TRUE){
  ps.q.agg.abs.pretty<-make_ps_pretty(ps.q.agg.abs,"Species")
}else{
  ps.q.agg.abs.pretty<-make_ps_pretty(ps.q.agg.abs,agglom.rank)
}
ps.q.agg.abs<-ps.q.agg.abs.pretty
rm(ps.q.agg.abs.pretty)

ps.q.agg.abs$Taxon.bp<-ps.q.agg.abs$Taxon
ps.q.agg.abs$Taxon.bp<-ifelse(ps.q.agg.abs[[agglom.rank.col]] %in% ps.q.1pc[[agglom.rank]],
                              ps.q.agg.abs$Taxon.bp,
                              "Remainder (Mean abundance < 1%)")
```

Save the image
```{r}
save.image(paste0("./rdafiles/pooled-",read.end.type,"-qiime2-",truncationlvl,"-",agglom.rank,
                  "-phyloseq-workspace.RData"))

```

